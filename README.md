# Интернет-магазин: Микросервисы Заказов и Платежей

Этот проект представляет собой реализацию микросервисной архитектуры для интернет-магазина, состоящую из следующих компонентов:

- **API Gateway**: Отвечает за маршрутизацию входящих запросов к соответствующим микросервисам.
- **Orders Service**: Управляет созданием заказов, их списком и статусами. Реализует паттерн Transactional Outbox для инициирования платежей. Внесены исправления для предотвращения создания заказов с отрицательной или нулевой суммой, а также для корректной сериализации десятичных чисел в ответах API.
- **Payments Service**: Обрабатывает операции, связанные с пользовательскими счетами: создание, пополнение и просмотр баланса. Реализует паттерны Transactional Inbox и Outbox для обеспечения гарантий доставки сообщений и атомарных операций с балансом.

## Технологии

- Python 3.9+
- FastAPI: Для создания RESTful API.
- SQLAlchemy: Для работы с базой данных.
- SQLite (по умолчанию): Для простоты разработки. Может быть заменено на PostgreSQL в продакшене.
- Uvicorn: ASGI сервер для запуска FastAPI приложений.
- Pytest: Для написания и запуска тестов.
- pytest-cov: Для генерации отчетов о покрытии кода.
- pytest-asyncio: Для тестирования асинхронного кода.

## Установка и запуск

### 1. Клонирование репозитория

```bash
git clone <your-repository-url>
cd kpo3_p
```

### 2. Создание виртуального окружения и установка зависимостей

```bash
python -m venv venv
venv\Scripts\activate
pip install -r requirements.txt
pip install pytest pytest-cov pytest-asyncio
```

_Примечание: Файл `requirements.txt` будет создан позже с необходимыми зависимостями._

### 3. Запуск сервисов

Каждый сервис запускается отдельно.

#### Payments Service
```bash
# В директории payments_service
uvicorn main:app --reload --port 8001
```

#### Orders Service
```bash
# В директории orders_service
uvicorn main:app --reload --port 8002
```

#### API Gateway
```bash
# В директории api_gateway
uvicorn main:app --reload --port 8000
```

## API Эндпоинты

### API Gateway (http://127.0.0.1:8000)

API Gateway отвечает за маршрутизацию входящих запросов к соответствующим микросервисам Orders и Payments. Детальные эндпоинты проксирования не отображаются в схеме OpenAPI (Swagger UI), так как являются внутренней реализацией маршрутизации.

- `GET /health`: Проверка работоспособности шлюза.

### Orders Service (http://127.0.0.1:8002)

- `POST /orders`: Создать новый заказ.
- `GET /orders`: Получить список заказов пользователя.
- `GET /orders/{order_id}`: Получить статус отдельного заказа.
- `POST /orders/payment-status`: Обновить статус заказа по результату оплаты (Transactional Inbox).

### Payments Service (http://127.0.0.1:8001)

- `POST /accounts`: Создать счёт для пользователя.
- `POST /accounts/top-up`: Пополнить счёт пользователя.
- `GET /accounts/{user_id}/balance`: Просмотреть баланс счёта.
- `POST /payments/process`: Обработка платежа (Transactional Inbox).

## Сценарий создания заказа и автооплаты

1.  **Пользователь отправляет запрос на создание нового заказа** в `API Gateway`, который перенаправляет его в `Orders Service`.
2.  **`Orders Service` создаёт заказ и задачу на оплату** в своей базе данных в рамках одной транзакции (Transactional Outbox).
3.  **`Orders Service` асинхронно извлекает задачу** из базы данных и отправляет её в очередь (или имитирует отправку, используя базу данных).
4.  **`Payments Service` извлекает задачу из очереди** (Transactional Inbox), обрабатывает её (создает счет, если его нет, списывает деньги, или регистрирует ошибку).
5.  **`Payments Service` сохраняет результат операции** в свою базу данных и асинхронно отправляет событие о статусе оплаты в очередь (Transactional Outbox).
6.  **`Orders Service` ожидает событие** об успешности/неуспешности оплаты из очереди и обновляет статус соответствующего заказа.

## Запуск тестов и проверка покрытия кода

Перейдите в корневую директорию проекта `kpo3_p`.

### Orders Service
```bash
pytest orders_service/tests/ --cov=orders_service/src
```

### Payments Service
```bash
pytest payments_service/tests/ --cov=payments_service/src
```

### API Gateway
```bash
pytest api_gateway/tests/ --cov=api_gateway/src
``` 